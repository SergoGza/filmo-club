<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org">

<!--/* @thymesVar id="film" type="com.videoclub.filmoapp.film.mvc.dto.FilmMvcDTO" */-->

<head th:replace="~{videoclub/fragments/head :: header(title = ${film.id != null ? 'FilmoClub - Edit Film' : 'FilmoClub - Create Film'})}"></head>

<body>

<nav th:replace="~{videoclub/fragments/nav :: nav}"></nav>

<div class="container">

    <div class="row py-3">
        <h1 class="border-bottom" th:text="${film.id != null ? 'Edit Film' : 'Create Film'}"></h1>
    </div>

    <div class="row py-2">
        <div class="col-md-8">
            <!-- ✅ UN SOLO FORM CON ENCTYPE -->
            <form class="row"
                  th:action="@{/videoclub/film/films-edit{filmId}(filmId=${film.id != null ? '/' + film.id : ''})}"
                  th:object="${film}"
                  method="post"
                  enctype="multipart/form-data">

                <!-- Campo hidden para el ID cuando sea edición -->
                <input type="hidden" th:field="*{id}" th:if="${film.id != null}">

                <div class="mb-3 row">
                    <label for="title" class="col-md-2 col-form-label">Title</label>
                    <div class="col-md-5">
                        <input type="text"
                               class="form-control"
                               id="title" name="title" th:field="*{title}"
                               placeholder="Film title"
                               required>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label for="releaseYear" class="col-md-2 col-form-label">Release Year</label>
                    <div class="col-md-5">
                        <input type="number"
                               class="form-control"
                               id="releaseYear" name="releaseYear" th:field="*{releaseYear}"
                               placeholder="2024" min="1900" max="2030"
                               required>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('releaseYear')}"
                             th:errors="*{releaseYear}"></div>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label for="directorId" class="col-md-2 col-form-label">Director</label>
                    <div class="col-md-5">
                        <select class="form-select"
                                aria-label="Director" id="directorId" name="directorId" th:field="*{directorId}"
                                required>
                            <option value="">Select director</option>
                            <option th:each="director: ${directors}"
                                    th:value="${director.id}"
                                    th:text="${director.name + ' ' + director.surname}"></option>
                        </select>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('directorId')}"
                             th:errors="*{directorId}"></div>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label for="actorIds" class="col-md-2 col-form-label">Actors</label>
                    <div class="col-md-5">
                        <select class="form-select" multiple
                                aria-label="Actors" id="actorIds" name="actorIds" th:field="*{actorIds}">
                            <option th:each="actor: ${actors}"
                                    th:value="${actor.id}"
                                    th:text="${actor.name + ' ' + actor.surname}"></option>
                        </select>
                        <div class="form-text">Hold Ctrl (Cmd on Mac) to select multiple actors</div>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('actorIds')}"
                             th:errors="*{actorIds}"></div>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label for="poster" class="col-md-2 col-form-label">Poster</label>
                    <div class="col-md-5">
                        <input type="file"
                               class="form-control"
                               id="poster"
                               name="poster"
                               accept="image/*"
                               th:required="${film.id == null}">
                        <div class="form-text">
                            <span th:if="${film.id == null}">Poster is required for new films</span>
                            <span th:if="${film.id != null}">Leave empty to keep current poster</span>
                        </div>
                    </div>
                </div>

                <!-- Mostrar errores globales si existen -->
                <div class="mb-3 row" th:if="${#fields.hasGlobalErrors()}">
                    <div class="offset-md-2 col-md-10">
                        <div class="alert alert-danger" role="alert">
                            <ul class="mb-0">
                                <li th:each="error : ${#fields.globalErrors()}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="offset-md-2">
                    <button class="btn btn-primary me-2" type="submit"
                            th:text="${film.id != null ? 'Update Film' : 'Create Film'}"></button>
                    <a th:href="@{/videoclub/film/films}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"
                        th:text="${film.id != null ? 'Edit Film Information' : 'Film Information'}"></h5>
                    <p class="card-text"
                       th:text="${film.id != null ?
                                'Modify the film information by updating the title, release year, director, and actors as needed.' :
                                'Create a new film by providing the title, release year, director, and actors. All fields are required.'}">
                    </p>

                    <!-- Mostrar información actual del film si es edición -->
                    <div th:if="${film.id != null}" class="mt-3">
                        <h6 class="text-muted">Current Information:</h6>
                        <p class="small mb-1"><strong>ID:</strong> <span th:text="${film.id}"></span></p>
                        <p class="small mb-1"><strong>Title:</strong> <span th:text="${film.title}"></span></p>
                        <p class="small mb-0"><strong>Year:</strong> <span th:text="${film.releaseYear}"></span></p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Mensaje de éxito si existe -->
    <div th:if="${successMessage}" class="row py-2">
        <div class="col-12">
            <div class="alert alert-success" role="alert" th:text="${successMessage}">
            </div>
        </div>
    </div>

</div>

<div th:insert="~{videoclub/fragments/scripts}"></div>

</body>
</html>